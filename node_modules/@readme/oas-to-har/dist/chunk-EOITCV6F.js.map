{"version":3,"sources":["../src/lib/configure-security.ts"],"sourcesContent":["import type { AuthForHAR } from './types.js';\nimport type { OASDocument, SecuritySchemeObject } from 'oas/types';\n\nimport { isRef } from 'oas/types';\n\nfunction harValue(type: 'cookies' | 'headers' | 'queryString', value: { name: string; value: string }) {\n  if (!value.value) return undefined;\n  return { type, value };\n}\n\nexport default function configureSecurity(apiDefinition: OASDocument, values: AuthForHAR, scheme: string) {\n  if (!scheme) return undefined;\n\n  if (Object.keys(values || {}).length === 0) return undefined;\n\n  if (!apiDefinition.components.securitySchemes[scheme]) return undefined;\n  const security = apiDefinition.components.securitySchemes[scheme] as SecuritySchemeObject & {\n    'x-bearer-format'?: string;\n  };\n\n  if (isRef(security)) {\n    return undefined;\n  } else if (!values[scheme]) {\n    // If we don't have any data for this auth scheme then we shouldn't add it.\n    return false;\n  }\n\n  if (security.type === 'http') {\n    if (security.scheme === 'basic') {\n      const auth = values[scheme];\n      if (typeof auth !== 'object') return false;\n      if (!auth.user && !auth.pass) return false;\n\n      let user = auth.user ?? null;\n      if (user === null || user.length === 0) {\n        user = '';\n      }\n\n      let pass = auth.pass ?? null;\n      if (pass === null || pass.length === 0) {\n        pass = '';\n      }\n\n      return harValue('headers', {\n        name: 'authorization',\n        value: `Basic ${Buffer.from(`${user}:${pass}`).toString('base64')}`,\n      });\n    } else if (security.scheme === 'bearer') {\n      return harValue('headers', {\n        name: 'authorization',\n        value: `Bearer ${values[scheme]}`,\n      });\n    }\n  }\n\n  if (security.type === 'apiKey') {\n    if (security.in === 'query') {\n      return harValue('queryString', {\n        name: security.name,\n        value: String(values[scheme]),\n      });\n    } else if (security.in === 'header') {\n      const header = {\n        name: security.name,\n        value: String(values[scheme]),\n      };\n\n      if (security['x-bearer-format']) {\n        // Uppercase: token -> Token\n        const bearerFormat = security['x-bearer-format'].charAt(0).toUpperCase() + security['x-bearer-format'].slice(1);\n        header.name = security.name;\n        header.value = `${bearerFormat} ${header.value}`;\n      }\n\n      return harValue('headers', header);\n    } else if (security.in === 'cookie') {\n      return harValue('cookies', {\n        name: security.name,\n        value: String(values[scheme]),\n      });\n    }\n  }\n\n  if (security.type === 'oauth2') {\n    return harValue('headers', {\n      name: 'authorization',\n      value: `Bearer ${values[scheme]}`,\n    });\n  }\n\n  return undefined;\n}\n"],"mappings":";AAGA,SAAS,aAAa;AAEtB,SAAS,SAAS,MAA6C,OAAwC;AACrG,MAAI,CAAC,MAAM;AAAO,WAAO;AACzB,SAAO,EAAE,MAAM,MAAM;AACvB;AAEe,SAAR,kBAAmC,eAA4B,QAAoB,QAAgB;AACxG,MAAI,CAAC;AAAQ,WAAO;AAEpB,MAAI,OAAO,KAAK,UAAU,CAAC,CAAC,EAAE,WAAW;AAAG,WAAO;AAEnD,MAAI,CAAC,cAAc,WAAW,gBAAgB,MAAM;AAAG,WAAO;AAC9D,QAAM,WAAW,cAAc,WAAW,gBAAgB,MAAM;AAIhE,MAAI,MAAM,QAAQ,GAAG;AACnB,WAAO;AAAA,EACT,WAAW,CAAC,OAAO,MAAM,GAAG;AAE1B,WAAO;AAAA,EACT;AAEA,MAAI,SAAS,SAAS,QAAQ;AAC5B,QAAI,SAAS,WAAW,SAAS;AAC/B,YAAM,OAAO,OAAO,MAAM;AAC1B,UAAI,OAAO,SAAS;AAAU,eAAO;AACrC,UAAI,CAAC,KAAK,QAAQ,CAAC,KAAK;AAAM,eAAO;AAErC,UAAI,OAAO,KAAK,QAAQ;AACxB,UAAI,SAAS,QAAQ,KAAK,WAAW,GAAG;AACtC,eAAO;AAAA,MACT;AAEA,UAAI,OAAO,KAAK,QAAQ;AACxB,UAAI,SAAS,QAAQ,KAAK,WAAW,GAAG;AACtC,eAAO;AAAA,MACT;AAEA,aAAO,SAAS,WAAW;AAAA,QACzB,MAAM;AAAA,QACN,OAAO,SAAS,OAAO,KAAK,GAAG,IAAI,IAAI,IAAI,EAAE,EAAE,SAAS,QAAQ,CAAC;AAAA,MACnE,CAAC;AAAA,IACH,WAAW,SAAS,WAAW,UAAU;AACvC,aAAO,SAAS,WAAW;AAAA,QACzB,MAAM;AAAA,QACN,OAAO,UAAU,OAAO,MAAM,CAAC;AAAA,MACjC,CAAC;AAAA,IACH;AAAA,EACF;AAEA,MAAI,SAAS,SAAS,UAAU;AAC9B,QAAI,SAAS,OAAO,SAAS;AAC3B,aAAO,SAAS,eAAe;AAAA,QAC7B,MAAM,SAAS;AAAA,QACf,OAAO,OAAO,OAAO,MAAM,CAAC;AAAA,MAC9B,CAAC;AAAA,IACH,WAAW,SAAS,OAAO,UAAU;AACnC,YAAM,SAAS;AAAA,QACb,MAAM,SAAS;AAAA,QACf,OAAO,OAAO,OAAO,MAAM,CAAC;AAAA,MAC9B;AAEA,UAAI,SAAS,iBAAiB,GAAG;AAE/B,cAAM,eAAe,SAAS,iBAAiB,EAAE,OAAO,CAAC,EAAE,YAAY,IAAI,SAAS,iBAAiB,EAAE,MAAM,CAAC;AAC9G,eAAO,OAAO,SAAS;AACvB,eAAO,QAAQ,GAAG,YAAY,IAAI,OAAO,KAAK;AAAA,MAChD;AAEA,aAAO,SAAS,WAAW,MAAM;AAAA,IACnC,WAAW,SAAS,OAAO,UAAU;AACnC,aAAO,SAAS,WAAW;AAAA,QACzB,MAAM,SAAS;AAAA,QACf,OAAO,OAAO,OAAO,MAAM,CAAC;AAAA,MAC9B,CAAC;AAAA,IACH;AAAA,EACF;AAEA,MAAI,SAAS,SAAS,UAAU;AAC9B,WAAO,SAAS,WAAW;AAAA,MACzB,MAAM;AAAA,MACN,OAAO,UAAU,OAAO,MAAM,CAAC;AAAA,IACjC,CAAC;AAAA,EACH;AAEA,SAAO;AACT;","names":[]}